# ğŸ­ ãƒ„ãƒ³ãƒ‡ãƒ¬Wav2Lip + TensorRT Face Restoration
# ã¹ã€åˆ¥ã«å²ä¸Šæœ€é€Ÿã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã£ã¦ã‚ã’ã‚‹ã‚ã‘ã˜ã‚ƒãªã„ã‘ã©...ğŸ’¢

FROM nvcr.io/nvidia/tensorrt:22.08-py3

# åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    cmake \
    build-essential \
    libopencv-dev \
    pkg-config \
    wget \
    git \
    python3-pip \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Pythonä¾å­˜é–¢ä¿‚
COPY requirements.txt /tmp/
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ”ãƒ¼
WORKDIR /app
COPY . /app/

# Face-Restoration-TensorRTãƒ“ãƒ«ãƒ‰
WORKDIR /app/face_restoration_tensorrt

# CMakeLists.txtã®TensorRTãƒ‘ã‚¹ä¿®æ­£
RUN sed -i 's|the_path_to/TensorRT/include|/usr/include/x86_64-linux-gnu|g' CMakeLists.txt && \
    sed -i 's|the_path_to/TensorRT/lib|/usr/lib/x86_64-linux-gnu|g' CMakeLists.txt

# ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨ãƒ“ãƒ«ãƒ‰
RUN mkdir -p build && cd build && \
    cmake .. && \
    make

# ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p models

# ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¢ãƒ—ãƒªãƒ«ãƒ¼ãƒˆã«æˆ»ã™
WORKDIR /app

# å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p input output checkpoints temp trt_cache

# å®Ÿè¡Œæ¨©ä»˜ä¸
RUN chmod +x face_restoration_tensorrt/build/demo && \
    chmod +x face_restoration_tensorrt/build/convert && \
    chmod +x face_restoration_tensorrt/build/face_restoration_batch

EXPOSE 8004

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["python3", "inference_fp16_yolo_cpp_tensorrt_gfpgan.py", "--help"]