# CodeFormerçµ±åˆç‰ˆDockerfile - ã¹ã€åˆ¥ã«ã‚ãªãŸã®ãŸã‚ã«CodeFormerå¯¾å¿œã—ã¦ã‚ã’ã‚‹ã‚ã‘ã˜ã‚ƒãªã„ã‘ã©ï¼ğŸ’¢
FROM nvcr.io/nvidia/pytorch:24.01-py3

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONPATH=/app
ENV CUDA_VISIBLE_DEVICES=0
ENV PIP_NO_CACHE_DIR=1
# headlessç’°å¢ƒè¨­å®šï¼ˆã¹ã€åˆ¥ã«ã‚ãªãŸã®ãŸã‚ã˜ã‚ƒãªã„ã‚“ã ã‹ã‚‰ã­ï¼ï¼‰
ENV QT_QPA_PLATFORM=offscreen
ENV DISPLAY=:99
ENV MPLBACKEND=Agg

# ========== STAGE 1: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ï¼ˆCodeFormerå¯¾å¿œç‰ˆï¼‰ ==========
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libglib2.0-0 \
    libgl1-mesa-glx \
    git \
    wget \
    build-essential \
    libopenblas-dev \
    liblapack-dev \
    libx11-dev \
    libgtk-3-dev \
    pkg-config \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libtbb-dev \
    libeigen3-dev \
    libdc1394-dev \
    libxss1 \
    python3-dev \
    xvfb \
    x11-utils \
    && rm -rf /var/lib/apt/lists/*

# CMakeã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null && \
    echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main' | tee /etc/apt/sources.list.d/kitware.list >/dev/null && \
    apt-get update && \
    apt-get install -y cmake && \
    rm -rf /var/lib/apt/lists/*

# ========== STAGE 2: åŸºæœ¬Pythonä¾å­˜é–¢ä¿‚ï¼ˆCodeFormeræœ€é©åŒ–ï¼‰ ==========
RUN pip install --no-cache-dir \
    numpy==1.26.1 \
    scipy==1.11.3

RUN pip install --no-cache-dir opencv-python==4.5.5.64

# ========== STAGE 3: PyTorchï¼ˆå®‰å®šç‰ˆï¼‰ ==========
RUN pip install --no-cache-dir \
    torch==2.1.0 \
    torchvision==0.16.0 \
    torchaudio==2.1.0

# ========== STAGE 4: éŸ³å£°ãƒ»å‹•ç”»å‡¦ç† ==========
RUN pip install --no-cache-dir \
    librosa==0.10.1 \
    moviepy==1.0.3 \
    imageio-ffmpeg==0.4.9

# ========== STAGE 5: dlibãƒ“ãƒ«ãƒ‰ï¼ˆé¡”æ¤œå‡ºã®ãŸã‚ã«å¿…é ˆï¼‰ ==========
ENV CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release -DDLIB_NO_GUI_SUPPORT=ON -DDLIB_USE_CUDA=OFF -DCMAKE_POLICY_VERSION_MINIMUM=3.5"
RUN pip install --no-cache-dir dlib==19.22.1 || \
    pip install --no-cache-dir --no-binary=dlib dlib==19.22.1 || \
    pip install --no-cache-dir face-recognition || \
    (wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
     bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda && \
     export PATH="/opt/conda/bin:$PATH" && \
     /opt/conda/bin/conda install -c conda-forge dlib -y && \
     rm Miniconda3-latest-Linux-x86_64.sh)

ENV PATH="/opt/conda/bin:$PATH"

# ========== STAGE 6: CodeFormerå°‚ç”¨ä¾å­˜é–¢ä¿‚ï¼ˆé‡è¦ï¼ï¼‰ ==========
# BasicSRï¼ˆCodeFormerã®ãƒ™ãƒ¼ã‚¹ï¼‰
RUN pip install --no-cache-dir \
    basicsr==1.4.2

# FaceXLibå°‚ç”¨ä¾å­˜é–¢ä¿‚ï¼ˆCodeFormerã®facelibå•é¡Œè§£æ±ºï¼‰
RUN pip install --no-cache-dir \
    filterpy \
    numba \
    scipy \
    filterpy

# FaceLibç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€æ–°ç‰ˆï¼‰
RUN pip install --no-cache-dir \
    facexlib

# CodeFormerå¿…é ˆä¾å­˜é–¢ä¿‚ï¼ˆå‚è€ƒãƒªãƒã‚¸ãƒˆãƒªã‚ˆã‚Šï¼‰
RUN pip install --no-cache-dir \
    addict \
    future \
    lmdb \
    pyyaml \
    requests \
    scikit-image \
    tb-nightly \
    yapf \
    lpips \
    gdown

# GFPGANï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
RUN pip install --no-cache-dir \
    gfpgan==1.3.8

# ãƒãƒƒãƒå‡¦ç†ç”¨
RUN pip install --no-cache-dir \
    --no-deps batch-face==1.4.0

# ========== STAGE 6.5: CodeFormerãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆé‡è¦ï¼ï¼‰ ==========
WORKDIR /tmp

# CodeFormerã‚’å®Œå…¨ã«ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦PythonPathã«è¿½åŠ 
RUN git clone https://github.com/sczhou/CodeFormer.git && \
    cd CodeFormer && \
    # BasicSRã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    python basicsr/setup.py develop && \
    # CodeFormerå…¨ä½“ã‚’/opt/ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cp -r . /opt/CodeFormer

# FaceLibã‚’ç›´æ¥CodeFormerã‹ã‚‰å–å¾—
RUN git clone https://github.com/xinntao/facexlib.git /opt/facexlib && \
    cd /opt/facexlib && \
    pip install -e .

# PythonPathã«CodeFormerã¨facelibã‚’è¿½åŠ 
ENV PYTHONPATH="${PYTHONPATH}:/opt/CodeFormer:/opt/facexlib:/app"

# CodeFormerã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦èªè­˜ã•ã›ã‚‹
RUN echo "import sys; sys.path.insert(0, '/opt/CodeFormer')" > /usr/local/lib/python3.10/dist-packages/codeformer_path.pth
RUN echo "import sys; sys.path.insert(0, '/opt/facexlib')" > /usr/local/lib/python3.10/dist-packages/facelib_path.pth

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
RUN rm -rf /tmp/CodeFormer

# ========== STAGE 7: ä»–ã®ä¾å­˜é–¢ä¿‚ ==========
RUN pip install --no-cache-dir \
    importlib-metadata==6.8.0 \
    ipython==8.16.1

RUN pip install --no-cache-dir \
    click \
    rich \
    loguru \
    ultralytics

# ========== STAGE 8: FastAPI Web Server ==========
RUN pip install --no-cache-dir \
    fastapi>=0.104.0 \
    uvicorn[standard]>=0.24.0 \
    python-multipart>=0.0.6 \
    aiofiles>=23.0.0 \
    starlette>=0.27.0 \
    requests>=2.31.0 \
    psutil>=5.9.0

# ========== STAGE 9: ONNXæœ€é©åŒ– ==========
RUN pip install --no-cache-dir \
    onnxruntime-gpu>=1.16.0 \
    omegaconf

# OpenCVå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆäº’æ›æ€§ç¢ºä¿ï¼‰
RUN pip install --force-reinstall --no-deps opencv-python==4.5.5.64

# ========== STAGE 10: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ==========
WORKDIR /app

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /app/{input,output,logs,models,scripts,config,checkpoints/CodeFormer}

# requirements.txtã‚’å…ˆã«ã‚³ãƒ”ãƒ¼
COPY requirements*.txt /app/

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
COPY . /app/

# CodeFormerãƒ¢ãƒ‡ãƒ«è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
RUN echo '#!/bin/bash\n\
echo "ğŸš€ CodeFormerãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹ğŸ’•"\n\
mkdir -p /app/checkpoints/CodeFormer\n\
cd /app/checkpoints/CodeFormer\n\
if [ ! -f "codeformer.pth" ]; then\n\
    echo "CodeFormerãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."\n\
    wget -O codeformer.pth https://github.com/sczhou/CodeFormer/releases/download/v0.1.0/codeformer.pth\n\
    echo "âœ… CodeFormerãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†"\n\
else\n\
    echo "âœ… CodeFormerãƒ¢ãƒ‡ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"\n\
fi\n\
echo "ã‚„ã£ãŸã˜ã‚ƒãªã„ï¼CodeFormeræº–å‚™å®Œäº†ã‚ˆâœ¨"' > /app/scripts/download_codeformer_model.sh && \
    chmod +x /app/scripts/download_codeformer_model.sh

# ========== STAGE 11: æ¤œè¨¼ï¼ˆCodeFormerå®Œå…¨ç¢ºèªï¼‰ ==========
RUN python -c "import torch; print('CUDA available:', torch.cuda.is_available())"
RUN python -c "import cv2; print('OpenCV version:', cv2.__version__)"
RUN python -c "import dlib; print('dlib imported successfully!')"
RUN python -c "import fastapi; print('FastAPI version:', fastapi.__version__)"
RUN python -c "import basicsr; print('BasicSR imported successfully!')"
RUN python -c "from basicsr.utils.registry import ARCH_REGISTRY; print('ARCH_REGISTRY available')"
RUN python -c "import onnxruntime; print('ONNX Runtime providers:', onnxruntime.get_available_providers())"

# CodeFormerå°‚ç”¨æ¤œè¨¼
RUN python -c "import facelib; print('âœ… facelib imported successfully!')"
RUN python -c "from facelib.utils.face_restoration_helper import FaceRestoreHelper; print('âœ… FaceRestoreHelper available')"
RUN python -c "from facelib.utils.misc import is_gray; print('âœ… facelib.utils.misc available')"
RUN python -c "from basicsr.utils import img2tensor, tensor2img; print('âœ… BasicSR utils available')"
RUN python -c "from basicsr.utils.download_util import load_file_from_url; print('âœ… BasicSR download utils available')"

# CodeFormerå®Œå…¨æ¤œè¨¼
RUN python -c "import sys; sys.path.insert(0, '/opt/CodeFormer'); from basicsr.utils.registry import ARCH_REGISTRY; print('âœ… ARCH_REGISTRY from CodeFormer:', 'CodeFormer' in str(ARCH_REGISTRY._obj_map.keys()))"

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 8002

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
CMD ["python", "inference_fp16_yolo_codeformer.py"]