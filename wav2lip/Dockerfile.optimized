# æœ€é©åŒ–ç‰ˆDockerfile - ã¹ã€åˆ¥ã«ã‚ãªãŸã®ãŸã‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–ã—ã¦ã‚ã’ã‚‹ã‚ã‘ã˜ã‚ƒãªã„ã‚“ã ã‹ã‚‰ã­ï¼
FROM nvcr.io/nvidia/pytorch:24.01-py3

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONPATH=/app
ENV CUDA_VISIBLE_DEVICES=0
ENV PIP_NO_CACHE_DIR=1
# headlessç’°å¢ƒè¨­å®šï¼ˆã¹ã€åˆ¥ã«ã‚ãªãŸã®ãŸã‚ã˜ã‚ƒãªã„ã‚“ã ã‹ã‚‰ã­ï¼ï¼‰
ENV QT_QPA_PLATFORM=offscreen
ENV DISPLAY=:99
ENV MPLBACKEND=Agg

# ========== STAGE 1: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ï¼ˆã»ã¼å¤‰æ›´ãªã—ï¼‰ ==========
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libglib2.0-0 \
    libgl1-mesa-glx \
    git \
    wget \
    build-essential \
    libopenblas-dev \
    liblapack-dev \
    libx11-dev \
    libgtk-3-dev \
    pkg-config \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libtbb-dev \
    libeigen3-dev \
    libdc1394-dev \
    libxss1 \
    python3-dev \
    xvfb \
    x11-utils \
    && rm -rf /var/lib/apt/lists/*

# CMakeã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null && \
    echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main' | tee /etc/apt/sources.list.d/kitware.list >/dev/null && \
    apt-get update && \
    apt-get install -y cmake && \
    rm -rf /var/lib/apt/lists/*

# ========== STAGE 2: åŸºæœ¬Pythonä¾å­˜é–¢ä¿‚ï¼ˆã‚ã¾ã‚Šå¤‰æ›´ãªã—ï¼‰ ==========
RUN pip install --no-cache-dir \
    numpy==1.26.1 \
    scipy==1.11.3

RUN pip install --no-cache-dir opencv-python==4.5.5.64

# ========== STAGE 3: é‡ã„PyTorchï¼ˆå¤‰æ›´ãªã—ï¼‰ ==========
RUN pip install --no-cache-dir \
    torch==2.1.0 \
    torchvision==0.16.0 \
    torchaudio==2.1.0

# ========== STAGE 4: éŸ³å£°ãƒ»å‹•ç”»å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰ ==========
RUN pip install --no-cache-dir \
    librosa==0.10.1 \
    moviepy==1.0.3 \
    imageio-ffmpeg==0.4.9

# ========== STAGE 5: dlibãƒ“ãƒ«ãƒ‰ï¼ˆæ™‚é–“ã‹ã‹ã‚‹ã‘ã©å¤‰æ›´ãªã—ï¼‰ ==========
ENV CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release -DDLIB_NO_GUI_SUPPORT=ON -DDLIB_USE_CUDA=OFF -DCMAKE_POLICY_VERSION_MINIMUM=3.5"
RUN pip install --no-cache-dir dlib==19.22.1 || \
    pip install --no-cache-dir --no-binary=dlib dlib==19.22.1 || \
    pip install --no-cache-dir face-recognition || \
    (wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
     bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda && \
     export PATH="/opt/conda/bin:$PATH" && \
     /opt/conda/bin/conda install -c conda-forge dlib -y && \
     rm Miniconda3-latest-Linux-x86_64.sh)

ENV PATH="/opt/conda/bin:$PATH"

# ========== STAGE 6: ä»–ã®ä¾å­˜é–¢ä¿‚ï¼ˆå¤‰æ›´å°‘ãªã„ï¼‰ ==========
RUN pip install --no-cache-dir \
    --no-deps batch-face==1.4.0 \
    gdown==4.7.1

RUN pip install --no-cache-dir \
    basicsr==1.4.2 \
    facexlib==0.3.0 \
    gfpgan==1.3.8 \
    importlib-metadata==6.8.0 \
    ipython==8.16.1

RUN pip install --no-cache-dir \
    click \
    rich \
    loguru \
    tqdm \
    pyyaml \
    ultralytics

# ========== STAGE 6.5: FastAPI Web Serverï¼ˆæ–°è¿½åŠ ï¼‰ ==========
RUN pip install --no-cache-dir \
    fastapi>=0.104.0 \
    uvicorn[standard]>=0.24.0 \
    python-multipart>=0.0.6 \
    aiofiles>=23.0.0 \
    starlette>=0.27.0 \
    requests>=2.31.0 \
    psutil>=5.9.0

# ========== STAGE 6.6: TensorRTç©¶æ¥µæœ€é©åŒ–ä¾å­˜é–¢ä¿‚ï¼ˆã¹ã€åˆ¥ã«ç©¶æ¥µåŒ–ã—ã¦ã‚ã’ã‚‹ã‚ã‘ã˜ã‚ƒãªã„ã‘ã©ï¼ğŸ’•ï¼‰ ==========
RUN pip install --no-cache-dir \
    pycuda \
    onnxruntime-gpu>=1.16.0 \
    omegaconf

# OpenCVå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --force-reinstall --no-deps opencv-python==4.5.5.64

# ========== STAGE 7: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé »ç¹ã«å¤‰æ›´ï¼‰ ==========
WORKDIR /app

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆæ§‹é€ ã ã‘å…ˆã«ä½œæˆï¼‰
RUN mkdir -p /app/{input,output,logs,models,scripts,config}

# requirements.txtã‚’å…ˆã«ã‚³ãƒ”ãƒ¼ï¼ˆä¾å­˜é–¢ä¿‚ã«å¤‰æ›´ãŒãªã‘ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ï¼‰
COPY requirements*.txt /app/
# è¿½åŠ ã®ä¾å­˜é–¢ä¿‚ãŒã‚ã‚Œã°ï¼ˆãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
# RUN pip install -r requirements.txt || true

# æœ€å¾Œã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆæœ€ã‚‚é »ç¹ã«å¤‰æ›´ã•ã‚Œã‚‹ï¼‰
COPY . /app/

# ========== STAGE 8: æ¤œè¨¼ï¼ˆPyCUDAã¯å®Ÿè¡Œæ™‚ãƒ†ã‚¹ãƒˆï¼‰ ==========
RUN python -c "import torch; print('CUDA available:', torch.cuda.is_available())"
RUN python -c "import cv2; print('OpenCV version:', cv2.__version__)"
RUN python -c "import dlib; print('dlib imported successfully!')"
RUN python -c "import fastapi; print('FastAPI version:', fastapi.__version__)"
RUN python -c "import tensorrt; print('TensorRT version:', tensorrt.__version__)"
RUN python -c "import onnxruntime; print('ONNX Runtime providers:', onnxruntime.get_available_providers())"
# PyCUDAã¯å®Ÿè¡Œæ™‚ã«GPUã‚¢ã‚¯ã‚»ã‚¹ä»˜ãã§ãƒ†ã‚¹ãƒˆã™ã‚‹

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 8002

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ (FastAPI server)
CMD ["python", "fastapi_wav2lip_server.py"]